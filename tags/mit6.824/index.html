<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>MIT6.824 - hwy的小窝</title><meta name=description content><meta name=author content="Baymax_hwy"><link href=https://baymaxhwy.github.io/an-old-hope.min.css rel=stylesheet><link href=https://baymaxhwy.github.io/style.css rel=stylesheet><link rel=apple-touch-icon href=https://baymaxhwy.github.io/apple-touch-icon.png><link rel=icon href=https://baymaxhwy.github.io/favicon.ico><meta name=generator content="Hugo 0.101.0"><link rel=alternate type=application/atom+xml href=https://baymaxhwy.github.io/index.xml title=hwy的小窝><script>function setTheme(){const n=new Date,a=localStorage.getItem("date"),s=String(n.getMonth()+1)+"."+String(n.getDate()),o=n.getTime();let e,t;function i(){if(o>e&&o<t)return;document.body.classList.add("dark")}s!==a?(fetch("https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215").then(e=>e.json()).then(n=>{e=n.sunrise.split(":").map(Number),t=n.sunset.split(":").map(Number)}).catch(()=>{e=[7,0],t=[19,0]}).finally(()=>{e=n.setHours(e[0],e[1],0),t=n.setHours(t[0],t[1],0),i(),localStorage.setItem("sunrise",e),localStorage.setItem("sunset",t)}),localStorage.setItem("date",s)):(e=Number(localStorage.getItem("sunrise")),t=Number(localStorage.getItem("sunset")),i())}</script></head><body class=list><script>setTheme()</script><header class=header><nav class=nav><p class=logo><a href=https://baymaxhwy.github.io/>hwy的小窝</a></p><ul class=menu><li><a href=/posts/>Blog</a></li><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li><li><a href=/about/>About</a></li></ul></nav></header><main class=main><header class=page-header><h1>MIT6.824</h1></header><article class=post-entry><header class=entry-header><h2>Raft总结</h2></header><section class=entry-content><p>前言 这里是对MIT6.824课程中有关Raft部分的一些总结（包括一些个人的理解以及Lab2的实现思路等）。首先还是很感谢MIT的大牛们能把这门神课开源出来，让更多的人能更加系统的学习分布式系统（搭配《DDIA》效果更佳！）。
简介 因为需要遵守 Collaboration Policy 不能公布全部代码，主要是思路和伪代码。
Raft是一个用于管理副本log的共识算法，它的功能类似于Paxos，但是比Paxos更简单（相对而言），更容易让人去理解学习，也容易在现实中实现。Raft主要有这几部分：领导选举、日志复制、集群变更、日志持久化、快照，本文只讨论与Lab2有关的部分。
共识算法—详细可以去看书 在6.824课程和《Raft》论文中对共识的阐释没有系统具体的阐释，这里主要是引用《DDIA》中的关于共识的部分内容：
共识问题是分布式计算中最重要也是最基本的问题之一。共识其实就是让几个节点就某件事情达成一致。这样表面上看去不是太难，但是因为分布式系统本身就是不可靠的，存在各种问题、失败、故障（网络故障、进程暂停、时钟问题等），想让多个节点到达共识其实是存在很大的难度。
共识算法需要满足一些性质：
协商一致性（Uniform agreement）：所有节点都接受相同的决议 诚实性（Integrity）：所有节点不能反悔，即对一项提议不能有两次决定 合法性（Validity）：如果决定了值v，则v一定由某个节点所提议 可终止性（Termination）：节点如果不崩溃则最终一定可以达成协议 协商一致性和诚实性决定了共识算法的核心思想：决定一致的结果，一旦决定，就不能改变。合法性（有效性，书里面会混用，属于翻译问题）则是排除一些无意义的方案，例如值为空（NULL）。前三个主要是保障了安全性（Safety），而可终止性则是引入了容错的思想。
2PC，两阶段提交也是共识算法但是不具有容错性，因为它的leader（独裁者、协调者）是人为指定的，也就没有可终止性，如果协调者故障则系统会一直原地空转
最著名的容错共识算法包括：VSR、Paxos、Raft和Zab（Zookeeper），他们大都不是直接使用上面的形式化描述。相反，他们是决定了一系列值，然后采用全序关系广播算法。
具体实现（思路和伪代码） 领导选举（Lab2A） 领导选举其实就是一次共识的过程，需要一个Candidate节点发起election让其与的节点来进行投票（vote）。
首先这里先介绍一下Raft中每个节点能够扮演的角色：
Follower：只负责接收Leader、Candidate的请求来进行响应，自身无法主动发起任何请求，但是会有一个election time，如果到期则会成为Candidate节点 Candidate：自身的term+1，重置election time，启动一个election vote活动，向集群中的所有节点发送vote请求，如果能在下一次election time到期之前获得大多数（Majority）节点的投票则会成为Leader（Candidate自己会投给自己），否则会开启新一轮的election Leader：每个term最多只有一个Leader，Leader会定时向集群中的节点发送心跳包来阻止新一轮的选举，同时会接受client的请求并复制到Follower节点 领导选举的整个流程：
首先所有节点初始化为Follower状态，并且设置election time（注意为了防止出现多个Candidate 的情况，需要在指定区间内随机time的值）
当time out时某个Follower会成为Candidate，开启一轮选举，如果获得大多数投票则选举成功，成为Leader，否则等待下一次time out开启新一轮选举。
Leader会以更短（比election time）的时间间隔向其他节点发送心跳包防止进行新选举
基本上需要按照论文中Figure2中的表示进行编写代码，不然容易出bug。这里需要注意的一点：
代码主要分为三部分：Election time超时机制，Candidate发起选举，RequestVote RPC处理
Election time超时机制。 首先每个Raft实例都会启动一个attemptElection的goroutine
func (rf *Raft) attemptElection() { for !rf.killed() { timeout := getRandTime() // 预定超时时间 time.Sleep(timeout) if time.Since(rf.lastHeartMsg) > timeout && rf.state != Leader { rf....</p></section><footer class=entry-footer><time>April 22, 2020</time></footer><a class=entry-link href=https://baymaxhwy.github.io/2020/mit6.824-raft/></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://baymaxhwy.github.io/>hwy的小窝</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</span>
<span>&#183;</span>
<span>Theme️ <a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper</a></span></footer><script src=https://baymaxhwy.github.io/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>